<!doctype html>
<head>
    <title>GatherSphere</title>
    <link rel="icon" href="../images/Globe.png" type=""image/x-icon">
    <link rel="stylesheet" type="text/css" href="../css/darkmode.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
</head>
<body>
    <header>
        <div class="navbar">
            <nav class="navigation hide" id="navigation">
                <ul class="nav-list">
                    <span class="close-nav" onclick="hideNavBar()"><img src="../images/nav-close.png" alt=" "></span>
                    <li class="nav-item"><a href="../Index.html">Home</a></li>
                    <li class="nav-item hide"><a href="account.html">Account</a></li>
                    <li class="nav-item hide"><a href= "login.html">Login/Sign Up</a></li>
                    <!--Responsive nav... display account when signed in/login when not-->
                </ul>
            </nav>
            <a href="#" class="nav-icon" id="navBar" onclick="openNavBar()"><img src="../images/nav-open.png" alt= "Navigation"></a>
            <a href="../Index.html" class="title-link"><div class="title">GatherSphere <img class="title-icon" src="../images/Globe.png" alt="Home"></div></a>
        </div>
    </header>

     <!--Search Box-->
     <div class="search-box">
        <select name="" id="searchFilter">
            <option value= "everything">Everything</option>
            <option value= "forum">Forums</option>
            <option value= "post">Post Titles</option>
            <option value= "description">Descriptions</option>
            <option value= "user">Users</option>
        </select>
        <input type="text" name="q" id="searchQuery" placeholder="Search the Sphere!">
        <button class="search" id="searchButton">Search</button>
    </div>
<!--Forum Header/Title-->
<div class="forum-title">
    <h2 id="forumTitle">Loading sphere...</h2>
</div>
<div class="forum-description">
    <p id="memberID">Members: 1</p></br>
    <p id="forumDescription">Loading description...</p>
</div>
<div class = "join-sphere">
    <button class="join-sphere-button" id="joinSphereButton">Join Sphere</button>
</div>

<!--Forum Settings Button for Admin Users-->
<div class="forum-settings-container">
    <button class="forum-settings-button" id="forumSettingsButton" style="display: none;">Edit Forum Settings</button>
</div>

<!--Forum Settings For Admin Users-->
<div class="forum-settings-container" id="forumSettingsSection" style="display: none;">
    <table class="forum-settings-table">
        <tr>
            <th>Sphere Title:</th>
            <td id="sphereTitleSetting">Title_of_Sphere</td>
            <td><button class="edit-button" id="editTitleButton">[Edit]</button></td>
        </tr>
        <tr>
            <th>Sphere Description:</th>
            <td id="sphereDescriptionSetting">What is this Sphere for? Who is it for? Any particular topics/important info?</td>
            <td><button class="edit-button" id="editDescriptionButton">[Edit]</button></td>
        </tr>
        <tr>
            <th>Member List</th>
            <td id="membersList"></td>
            <td><button class="edit-button" id="editMembersButton">[Edit]</button></td>
        </tr>
        <tr>
            <th>Admin List</th>
            <td id="adminsList"></td>
            <td><button class="edit-button" id="editAdminsButton">[Edit]</button></td>
        </tr>
    </table>
</div>

<!--Create Post Button-->
<div class="create-post">
    <button class="create-post-button">Create Post</button>
</div>

<!--Hidden Post Creation Section-->
<div class="post-creation" id="createPost">
    <form id="postForm">
        <label for="post-title" class="post-form-title">Post Title:</label>
        <input type="text" name="post-title" id="userPostTitle" placeholder="Title your post" required>
        <label for="post-content" class="content-label">Post Content:</label>
        <textarea name="post-content" id="post-content" cols="30" rows="10" placeholder="Write something here!" required></textarea>
        <button type="submit" class="submit-post">Submit Post</button>
    </form>
</div>

<!--Posts Table-->
<div class="container">
    <table class="posts-table">
        <thead>
            <tr class="table-head">
                <th class="subject">Subject</th>
                <th class="replies">Replies/Views</th>
                <th class="last-reply">Last Reply</th>
            </tr>
        </thead>
        <tbody id="postsTableBody">
            <!-- Posts will be loaded dynamically -->
        </tbody>
    </table>
</div>

<footer>
    <span>&copy; &nbsp; GatherSphere | All Rights Reserved</span>
</footer>
<script src="../JavaScript/nav.js"></script>
<script>
// Check auth status
const authToken = localStorage.getItem('authToken');
const userId = localStorage.getItem('userId');
let currentSphereId = null;
let isAdmin = false;
let isMember = false; // Track if current user is a member

// Get sphere ID from URL parameters
function getSphereId() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id');
}

// Load sphere data
async function loadSphereData() {
    try {
        const sphereId = getSphereId();
        if (!sphereId) {
            document.getElementById('forumTitle').textContent = 'Sphere not found';
            return;
        }
        
        currentSphereId = sphereId;

        // Fetch sphere data FIRST to get member count
        const sphereResponse = await fetch(`/api/spheres/${sphereId}`);
        if (!sphereResponse.ok) {
            throw new Error('Failed to load sphere');
        }
        const sphere = await sphereResponse.json();

        // Update page title and document title
        document.getElementById('forumTitle').textContent = `Welcome to ${sphere.name}!`;
        document.title = `GatherSphere - ${sphere.name}`;

        // Update member count display
        document.getElementById('memberID').textContent = `Members: ${sphere.member_count || 0}`;
        document.getElementById('forumDescription').textContent = sphere.description || 'Loading description...'; // Also update description here

        // Update settings section
        document.getElementById('sphereTitleSetting').textContent = sphere.name;
        document.getElementById('sphereDescriptionSetting').textContent = sphere.description || 'No description available';


        // Check membership status AND admin status in one go if logged in
        if (authToken) {
            await checkMembershipAndAdminStatus(sphereId); // Combine checks
        } else {
             // Handle non-logged in users for Join button
            const joinButton = document.getElementById('joinSphereButton');
            joinButton.disabled = true;
            joinButton.textContent = 'Login to Join';
            joinButton.onclick = () => { // Use onclick for simplicity here as we might re-attach later
                window.location.href = 'login.html';
            };
            updateJoinButtonState(); // Update button state (will hide create post button)
        }


        // Load posts for this sphere
        loadPosts(sphereId);
    } catch (error) {
        console.error('Error loading sphere data:', error);
        document.getElementById('forumTitle').textContent = 'Error loading sphere';
    }
}

// Combined check for Membership and Admin Status
async function checkMembershipAndAdminStatus(sphereId) {
     if (!authToken || !userId || !sphereId) {
        isMember = false;
        isAdmin = false;
        updateJoinButtonState(); // Update UI based on defaults
        return; // Exit if not logged in or no sphereId
    }
    try {
        const response = await fetch(`/api/spheres/${sphereId}/members`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });

        if (response.status === 401 || response.status === 403) { // Handle potential auth errors
             console.error("Auth error fetching members:", response.status);
             isMember = false;
             isAdmin = false;
             updateJoinButtonState();
             return;
        }

        if (response.ok) {
            const members = await response.json();
            const currentUserMembership = members.find(member => member.user_id == userId);

            if (currentUserMembership) {
                isMember = true;
                isAdmin = currentUserMembership.role === 'admin';

                // Load member lists if admin
                if (isAdmin) {
                    let adminsListHTML = '';
                    let membersListHTML = ''; // Renamed variable to avoid conflict

                    members.forEach(member => {
                        if (member.role === 'admin') {
                            adminsListHTML += `<div>${member.username}</div>`;
                        } else {
                             membersListHTML += `<div>${member.username}</div>`;
                        }
                    });

                    document.getElementById('adminsList').innerHTML = adminsListHTML || 'No admins';
                    document.getElementById('membersList').innerHTML = membersListHTML || 'No other members'; // Adjusted message
                 }

            } else {
                isMember = false;
                isAdmin = false;
            }

            // Show settings button if admin
            document.getElementById('forumSettingsButton').style.display = isAdmin ? 'block' : 'none';

        } else {
             console.error('Failed to fetch members:', response.status);
             isMember = false;
             isAdmin = false;
        }
    } catch (error) {
        console.error('Error checking membership/admin status:', error);
        isMember = false;
        isAdmin = false;
    } finally {
         updateJoinButtonState(); // Ensure UI is updated regardless of outcome
    }
}


// Update Join Button state based on membership status
function updateJoinButtonState() {
    const joinButton = document.getElementById('joinSphereButton');
    const createPostContainer = document.querySelector('.create-post'); // Target the container div
    const createPostButton = document.querySelector('.create-post-button'); // The actual button

    // Clear previous listener to avoid duplicates if this runs multiple times
    joinButton.replaceWith(joinButton.cloneNode(true));
    const newJoinButton = document.getElementById('joinSphereButton'); // Get the new button reference

    if (isMember) {
        newJoinButton.textContent = '✓ Joined';
        newJoinButton.disabled = true;
        newJoinButton.classList.add('joined');
        if (createPostContainer) createPostContainer.style.display = 'flex'; // Show container
        if (createPostButton) createPostButton.style.display = 'block'; // Show button

    } else {
        newJoinButton.textContent = 'Join Sphere';
        newJoinButton.disabled = false;
        newJoinButton.classList.remove('joined');
         // Add click event listener to handle joining only if not a member
        if (authToken) { // Only add join listener if logged in
             newJoinButton.addEventListener('click', handleJoinSphere);
        } else { // If not logged in, keep the 'Login to Join' state
            newJoinButton.disabled = true;
            newJoinButton.textContent = 'Login to Join';
            newJoinButton.onclick = () => { window.location.href = 'login.html'; };
        }

        if (createPostContainer) createPostContainer.style.display = 'none'; // Hide container
        if (createPostButton) createPostButton.style.display = 'none'; // Hide button
    }
}


// Handle Join Sphere button click
async function handleJoinSphere() {
    // Redundant auth check, but good practice
    if (!authToken) {
        alert('Please log in to join this sphere');
        window.location.href = 'login.html';
        return;
    }
    if (!currentSphereId) return; // Should not happen if loadSphereData worked

    const joinButton = document.getElementById('joinSphereButton'); // Get button reference
    joinButton.disabled = true; // Disable button during request
    joinButton.textContent = 'Joining...';

    try {
        const response = await fetch(`/api/spheres/${currentSphereId}/members`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });

        if (response.status === 401 || response.status === 403) {
             localStorage.removeItem('authToken'); // Handle auth expiry
             localStorage.removeItem('userId');
             localStorage.removeItem('username');
             alert('Authentication error. Please log in again.');
             window.location.href = 'login.html';
             return;
        }

        const result = await response.json();

        if (response.ok) {
            // Update status and UI
            isMember = true;
            alert('Successfully joined sphere!');
            // Refresh sphere data to update member count and re-run checks
            await loadSphereData(); // Reload all data including member count and checks
        } else {
            // Show error message
            alert(result.error || 'Failed to join sphere. Please try again.');
            updateJoinButtonState(); // Re-enable button with correct text if failed
        }
    } catch (error) {
        console.error('Error joining sphere:', error);
        alert('An error occurred while trying to join the sphere');
        updateJoinButtonState(); // Re-enable button with correct text on network error
    }
}

// Load posts for specific sphere
function loadPosts(sphereId) {
    if (!sphereId) return;
    fetch(`/api/spheres/${sphereId}/posts`)
        .then(response => response.json())
        .then(posts => {
            const tbody = document.getElementById('postsTableBody');
            tbody.innerHTML = ''; // Clear previous posts

            if (!posts || posts.length === 0) {
                const row = document.createElement('tr');
                row.className = 'table-row'; // Apply styling
                row.innerHTML = '<td colspan="3" style="text-align: center; padding: 10px;">No posts yet. Be the first!</td>'; // Style the message cell
                tbody.appendChild(row);
                return;
            }

            posts.forEach(post => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                 // Make sure last reply info exists before trying to access properties
                const lastReplyAuthor = post.last_reply_author || post.author_name || 'Unknown';
                const lastReplyAuthorId = post.last_reply_author_id || post.author_id || '#';
                const lastReplyDate = post.last_reply_date || post.created_at;

                row.innerHTML = `
                    <td class="subject">
                        <a href="post-view.html?id=${post.id}">${post.subject}</a><br>
                        <span>Started by <b><a href="account.html?id=${post.author_id}">${post.author_name || 'Unknown'}</a></b></span>
                    </td>
                    <td class="replies">
                        ${post.replies || 0} replies<br>
                        ${post.views || 0} views | <span id="likes-${post.id}">${post.likes || 0}</span> likes
                        <br><button class="like-button" data-post-id="${post.id}">Like</button>
                    </td>
                    <td class="last-reply">
                        Last reply by <b><a href="account.html?id=${lastReplyAuthorId}">${lastReplyAuthor}</a></b><br>
                        on <small>${new Date(lastReplyDate).toLocaleDateString()}</small>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Add event listeners to like buttons
            document.querySelectorAll('.like-button').forEach(button => {
                 // Remove previous listener if any (safer)
                button.replaceWith(button.cloneNode(true));
            });
             document.querySelectorAll('.like-button').forEach(button => {
                button.addEventListener('click', handleLike);
            });

        })
        .catch(error => {
            console.error('Error loading posts:', error);
            const tbody = document.getElementById('postsTableBody');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: red;">Error loading posts.</td></tr>';
        });
}


// Handle post likes
function handleLike(event) {
    if (!authToken) {
        alert('Please log in to like posts');
        window.location.href = 'login.html'; // Redirect to login
        return;
    }

    const postId = event.target.dataset.postId;
    const button = event.target;
    button.disabled = true; // Disable button during request

    fetch(`/api/posts/${postId}/like`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${authToken}`
        }
    })
    .then(response => {
        if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
            return Promise.reject('Authentication failed'); // Stop processing
        }
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err)); // Handle other errors
        }
        return response.json();
    })
    .then(data => {
        if (data && data.likes !== undefined) {
            document.getElementById(`likes-${postId}`).textContent = data.likes;
            // Optional: Change button text (e.g., Liked/Unlike) based on data.liked
             button.textContent = data.liked ? 'Unlike' : 'Like';
        }
    })
    .catch(error => {
        console.error('Error liking post:', error);
        // Optionally display error to user
        alert(`Error: ${error.message || error.error || 'Could not like post'}`);
    })
    .finally(() => {
         button.disabled = false; // Re-enable button
    });
}


// Handle search functionality
document.getElementById('searchButton').addEventListener('click', function() {
    const query = document.getElementById('searchQuery').value.trim();
    const filter = document.getElementById('searchFilter').value;

    if (query) {
        window.location.href = `search-results.html?q=${encodeURIComponent(query)}&filter=${encodeURIComponent(filter)}`;
    }
});

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    // Initial Nav Update based on auth can be handled by nav.js itself if checkAuthStatus is called there
    // If nav.js doesn't call it, uncomment the block below:
    /*
    const accountNavItem = document.querySelector('.nav-item a[href="account.html"]').parentElement; // More specific selector
    const loginNavItem = document.querySelector('.nav-item a[href="login.html"]').parentElement; // More specific selector
    const logoutItem = document.querySelector('#logoutItem');

    if (authToken) {
        if(accountNavItem) accountNavItem.classList.remove('hide');
        if(loginNavItem) loginNavItem.classList.add('hide');
        if (logoutItem) logoutItem.classList.remove('hide');
    } else {
        if(accountNavItem) accountNavItem.classList.add('hide');
        if(loginNavItem) loginNavItem.classList.remove('hide');
        if (logoutItem) logoutItem.classList.add('hide');
    }
    */

    // Load sphere data (this will also trigger membership checks and UI updates)
    loadSphereData();

    // Add event handler for the correct post form submission
    document.getElementById('postForm').addEventListener('submit', async function(event) {
        event.preventDefault(); // Prevent default regardless of auth

        if (!authToken) {
            alert('Please log in to create a post');
            window.location.href = 'login.html';
            return;
        }

        if (!isMember) {
            alert('You need to join this sphere to create a post');
            return;
        }

        const postTitle = document.getElementById('userPostTitle').value.trim();
        const postContent = document.getElementById('post-content').value.trim();

        if (!postTitle || !postContent) {
            alert('Please provide both title and content for your post');
            return;
        }

        const submitButton = this.querySelector('.submit-post'); // Get the submit button
        submitButton.disabled = true; // Disable button during request
        submitButton.textContent = 'Submitting...';

        try {
            const response = await fetch('/api/posts', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sphere_id: currentSphereId,
                    subject: postTitle, // Correct field name
                    content: postContent
                    // 'tags' is omitted as there's no input field for it
                })
            });

             if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userId');
                localStorage.removeItem('username');
                window.location.href = 'login.html';
                return; // Stop execution
            }

            const result = await response.json(); // Try parsing JSON regardless of status

            if (response.ok) {
                // Clear form fields
                document.getElementById('userPostTitle').value = '';
                document.getElementById('post-content').value = '';

                // Hide the post creation form
                document.getElementById('createPost').style.display = 'none';

                // Reload posts to show the new post
                loadPosts(currentSphereId);

                alert('Post created successfully!');
            } else {
                 // Use error message from backend if available
                alert(`Failed to create post: ${result.error || `Server responded with status ${response.status}`}`);
            }
        } catch (error) {
            console.error('Error creating post:', error);
            alert('Failed to create the post. Please check your connection and try again.');
        } finally {
             submitButton.disabled = false; // Re-enable button
             submitButton.textContent = 'Submit Post';
        }
    });

    // Add event handler for the "Create Post" button (toggle visibility)
    document.querySelector('.create-post-button').addEventListener('click', function() {
        // Auth/Membership checks should happen before showing the button itself,
        // but double-checking here is okay.
        if (!authToken) {
            alert('Please log in to create a post');
            window.location.href = 'login.html';
            return;
        }
        if (!isMember) {
            alert('You need to join this sphere to create a post');
            return;
        }

        const createPostSection = document.getElementById('createPost');
        // Toggle display between 'none' and 'flex' (as per your CSS)
        createPostSection.style.display = (createPostSection.style.display === 'none' || createPostSection.style.display === '') ? 'flex' : 'none';
    });

    // Initially hide the post creation form
    document.getElementById('createPost').style.display = 'none';

     // Show/hide forum settings toggle
    const forumSettingsButton = document.getElementById('forumSettingsButton');
    const forumSettingsSection = document.getElementById('forumSettingsSection');
    if(forumSettingsButton && forumSettingsSection){
        forumSettingsButton.addEventListener('click', function() {
            // This assumes the button is only visible to admins due to loadSphereData logic
            forumSettingsSection.style.display = forumSettingsSection.style.display === 'none' ? 'block' : 'none'; // Use 'block' based on CSS
        });
         // Initially hide forum settings
         forumSettingsSection.style.display = 'none';
    }

});
</script>

</body>
</html>